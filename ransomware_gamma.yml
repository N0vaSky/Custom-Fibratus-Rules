name: Crypto Library Kill Rule
id: b3a92c74-8f16-4d5a-9e2c-f256871bc432
version: 1.2.0
description: |
  Kills processes attempting to access cryptographic libraries and DLLs,
  with improved exclusions for legitimate system processes.

enabled: true

labels:
  tactic.id: TA0040
  tactic.name: Impact
  tactic.ref: https://attack.mitre.org/tactics/TA0040/
  technique.id: T1486
  technique.name: Data Encrypted for Impact
  technique.ref: https://attack.mitre.org/techniques/T1486/

tags:
  - ransomware
  - crypto-libraries

condition: >
  kevt.name in ('CreateFile', 'MapViewFile', 'LoadImage')
    and
  (
    file.name iendswith (
      'bcrypt.dll',
      'ncrypt.dll',
      'crypt32.dll',
      'cryptdll.dll',
      'cryptsp.dll',
      'cryptbase.dll',
      'cryptui.dll'
    )
      or
    file.name imatches (
      '*\\Crypto\\Cipher\\*',
      '*\\cryptography\\hazmat\\*',
      '*\\_Salsa20.*.pyd',
      '*\\_ARC4.*.pyd'
    )
  )
    and
  not (
    ps.name in (
      'svchost.exe',
      'services.exe',
      'lsass.exe',
      'csrss.exe',
      'smss.exe',
      'wininit.exe',
      'winlogon.exe',
      'explorer.exe',
      'System',
      'vmwp.exe',
      'vmcompute.exe',
      'MsMpEng.exe',
      'TrustedInstaller.exe',
      'dllhost.exe'
    )
      or
    ps.exe imatches (
      '?:\\Windows\\System32\\*',
      '?:\\Windows\\SysWOW64\\*',
      '?:\\Program Files\\Windows Defender\\*',
      '?:\\Program Files\\Common Files\\System\\*',
      '?:\\Program Files\\*\\*.exe',
      '?:\\Program Files (x86)\\*',
      '?:\\Windows\\sysnative\\*',
      '?:\\Users\\*\\AppData\\Local\\*',
      '?:\\Windows\\SystemApps\\*'
    )
      or
    ps.domain in (
      'NT VIRTUAL MACHINE',
      'NT AUTHORITY'
    )
      or
    ps.username = 'SYSTEM'
      or
    ps.parent.name in (
      'services.exe',
      'wininit.exe',
      'vmcompute.exe'
    )
  )

output: |
  Crypto library access killed: %ps.name (PID %ps.pid) accessing %file.name

severity: critical

action:
  - name: kill

min-engine-version: 2.0.0
