name: Malicious Executable Memory Pattern
id: 01a45edb-78c2-4a39-9d7c-2f19e384517c
version: 1.0.0
description: |
  Detects malicious processes through their distinctive pattern of repeated self-executable
  mapping and file operations during initial startup. This pattern indicates potential
  system compromise through memory manipulation techniques commonly used in ransomware
  but also seen in other critical threats requiring immediate investigation.

enabled: true

labels:
  tactic.id: TA0040
  tactic.name: Impact
  tactic.ref: https://attack.mitre.org/tactics/TA0040/
  technique.id: T1486
  technique.name: Data Encrypted for Impact
  technique.ref: https://attack.mitre.org/techniques/T1486/

tags:
  - ransomware
  - early-detection
  - memory-patterns

references:
  - https://attack.mitre.org/techniques/T1486/

condition: >
  sequence
    maxspan 50ms
    by ps.uuid
    |(
      kevt.name = 'MapViewFile'
      and file.view.type = 'PAGEFILE'
      and not (
        ps.name in (
          'svchost.exe',
          'services.exe',
          'lsass.exe',
          'csrss.exe',
          'smss.exe',
          'wininit.exe',
          'winlogon.exe',
          'explorer.exe',
          'System',
          'MsMpEng.exe',
          'TrustedInstaller.exe',
          'RuntimeBroker.exe',
          'SearchIndexer.exe',
          'spoolsv.exe'
        )
        or ps.exe imatches (
          '?:\\Windows\\System32\\*',
          '?:\\Windows\\explorer.exe',
          '?:\\Program Files\\Windows Defender\\*'
        )
        or ps.parent.name in (
          'services.exe',
          'wininit.exe',
          'lsass.exe',
          'winlogon.exe',
          'System',
          'explorer.exe',
          'svchost.exe'
        )
        or ps.sid = 'S-1-5-18'
        or kevt.arg[cmdline] icontains (
          '-k netsvcs',
          '-k DcomLaunch',
          'RuntimeBroker',
          '-Embedding'
        )
      )
    )|
    |(
      kevt.name = 'CreateFile'
      and kevt.arg[share_mask] = 'READ|DELETE'
      and kevt.arg[file_name] iendswith '.exe'
      and not file.name imatches (
        '?:\\Windows\\System32\\*',
        '?:\\Windows\\SysWOW64\\*',
        '?:\\Program Files\\*',
        '?:\\ProgramData\\*'
      )
      and not ps.sid = 'S-1-5-18'
    )|
    |(
      kevt.name = 'MapViewFile'
      and file.view.type = 'DATA'
      and not (
        file.name imatches (
          '?:\\Users\\*\\AppData\\Local\\Microsoft\\Windows\\Explorer\\thumbcache_*.db',
          '?:\\Program Files\\*',
          '?:\\Windows\\*'
        )
        or ps.sid = 'S-1-5-18'
      )
    )|

output: |
  Potential Malicious Executable Memory Pattern detected:
  Process: %ps.name (PID: %ps.pid)
  Command Line: %ps.cmdline
  Parent Process: %ps.parent.name (PPID: %ps.ppid)
  Executable Path: %ps.exe

severity: critical

action:
  - name: kill

min-engine-version: 2.0.0
