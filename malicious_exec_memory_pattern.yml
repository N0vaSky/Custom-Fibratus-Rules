name: Malicious Executable Memory Pattern
id: 01a45edb-78c2-4a39-9d7c-2f19e384517c
version: 1.1.0
description: |
  Detects malicious processes through their distinctive pattern of repeated self-executable
  mapping and file operations during initial startup. This pattern indicates potential
  system compromise through memory manipulation techniques commonly used in ransomware
  but also seen in other critical threats requiring immediate investigation.

enabled: true

labels:
  tactic.id: TA0040
  tactic.name: Impact
  tactic.ref: https://attack.mitre.org/tactics/TA0040/
  technique.id: T1486
  technique.name: Data Encrypted for Impact
  technique.ref: https://attack.mitre.org/techniques/T1486/

tags:
  - ransomware
  - early-detection
  - memory-patterns

references:
  - https://attack.mitre.org/techniques/T1486/

condition: >
  sequence
    maxspan 20ms
    by ps.uuid
    |(
      kevt.name = 'MapViewFile'
      and file.view.type = 'PAGEFILE'
      and not ps.sid = 'S-1-5-18'
      and not ps.name imatches 'svchost.exe'
      and not ps.name in (
        'services.exe',
        'lsass.exe',
        'csrss.exe',
        'smss.exe',
        'wininit.exe',
        'winlogon.exe',
        'explorer.exe',
        'System',
        'MsMpEng.exe',
        'TrustedInstaller.exe',
        'RuntimeBroker.exe',
        'SearchIndexer.exe',
        'spoolsv.exe'
      )
      and not kevt.arg[cmdline] icontains (
        '-k netsvcs',
        '-k DcomLaunch',
        'RuntimeBroker',
        '-Embedding',
        '--start-in-tray',
        'UpdateDeploymentProvider',
        '/RunHandlerComServer'
      )
      and not ps.parent.exe imatches ('?:\\WINDOWS\\System32\\*', '?:\\Windows\\System32\\*')
      and not ps.parent.exe imatches ('?:\\Program Files\\*', '?:\\Program Files (x86)\\*')
      and not ps.exe imatches ('?:\\WINDOWS\\System32\\*', '?:\\Windows\\System32\\*')
      and not ps.exe imatches ('?:\\WINDOWS\\SysWOW64\\*', '?:\\Windows\\SysWOW64\\*')
      and not ps.exe imatches ('?:\\Program Files\\*', '?:\\Program Files (x86)\\*')
      and not ps.exe imatches '?:\\Users\\*\\AppData\\Local\\Programs\\*'
      and not ps.exe imatches '?:\\ProgramData\\*'
      and not pe.is_signed
    )|
    |(
      kevt.name = 'CreateFile'
      and kevt.arg[share_mask] = 'READ|DELETE'
      and kevt.arg[file_name] iendswith '.exe'
      and not ps.sid = 'S-1-5-18'
      and not ps.name imatches 'svchost.exe'
      and not ps.name in (
        'services.exe',
        'lsass.exe',
        'csrss.exe',
        'smss.exe',
        'wininit.exe',
        'winlogon.exe',
        'explorer.exe'
      )
      and not ps.exe imatches ('?:\\WINDOWS\\System32\\*', '?:\\Windows\\System32\\*')
      and not ps.exe imatches ('?:\\WINDOWS\\SysWOW64\\*', '?:\\Windows\\SysWOW64\\*')
      and not ps.exe imatches ('?:\\Program Files\\*', '?:\\Program Files (x86)\\*')
      and not file.name imatches ('?:\\WINDOWS\\System32\\*', '?:\\Windows\\System32\\*')
      and not file.name imatches ('?:\\WINDOWS\\SysWOW64\\*', '?:\\Windows\\SysWOW64\\*')
      and not file.name imatches ('?:\\Program Files\\*', '?:\\Program Files (x86)\\*')
      and not file.name imatches '?:\\ProgramData\\*'
      and not file.name imatches '?:\\Users\\*\\AppData\\Local\\Programs\\*'
      and not file.name imatches '?:\\Windows\\SoftwareDistribution\\*'
      and not pe.is_signed
    )|
    |(
      kevt.name = 'MapViewFile'
      and file.view.type = 'DATA'
      and not ps.sid = 'S-1-5-18'
      and not ps.name imatches 'svchost.exe'
      and not ps.exe imatches ('?:\\WINDOWS\\System32\\*', '?:\\Windows\\System32\\*')
      and not ps.exe imatches ('?:\\WINDOWS\\SysWOW64\\*', '?:\\Windows\\SysWOW64\\*')
      and not ps.exe imatches ('?:\\Program Files\\*', '?:\\Program Files (x86)\\*')
      and not ps.exe imatches '?:\\Users\\*\\AppData\\Local\\Programs\\*'
      and not ps.exe imatches '?:\\ProgramData\\*'
      and not file.name imatches ('?:\\WINDOWS\\*', '?:\\Windows\\*')
      and not file.name imatches ('?:\\Program Files\\*', '?:\\Program Files (x86)\\*')
      and not file.name imatches '?:\\Users\\*\\AppData\\Local\\Programs\\*'
      and not file.name imatches '?:\\Users\\*\\AppData\\Local\\Microsoft\\Windows\\Explorer\\*'
      and not pe.is_signed
    )|

output: |
  Potential Malicious Executable Memory Pattern detected:
  Process: %ps.name (PID: %ps.pid)
  Command Line: %ps.cmdline
  Parent Process: %ps.parent.name (PPID: %ps.ppid)
  Executable Path: %ps.exe

severity: critical

action:
  - name: kill

min-engine-version: 2.0.0