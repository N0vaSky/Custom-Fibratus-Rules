name: Suspicious persistence via registry modification
id: 1f496a17-4f0c-491a-823b-7a70adb9919c
version: 1.0.2
description: |
  Adversaries may abuse the registry to achieve persistence
  by modifying the keys that are unlikely modified by legitimate
  processes.
labels:
  tactic.id: TA0006
  tactic.name: Persistence
  tactic.ref: https://attack.mitre.org/tactics/TA0006/
  technique.id: T1547
  technique.name: Boot or Logon Autostart Execution
  technique.ref: https://attack.mitre.org/techniques/T1547/
  subtechnique.id: T1547.001
  subtechnique.name: Registry Run Keys / Startup Folder
  subtechnique.ref: https://attack.mitre.org/techniques/T1547/001/

condition: >
  modify_registry
    and
  (
    (ps.name in script_interpreters or ps.name in ('reg.exe', 'rundll32.exe', 'regsvr32.exe'))
      or
     ps.exe imatches '?:\\Users\\Public\\*'
      or
     pe.is_signed = false or pe.is_trusted = false
  )
    and
  registry.path imatches registry_persistence_keys

output: |
  Process Information:

  - Process Name: %ps.name 
  - Command Line: %ps.cmdline
  - Parent Process: %ps.parent.name (PPID: %ps.ppid)

  - Signature Status: %pe.is_signed
  - Cert Subject: %pe.cert.subject
  - Cert Issuer: %pe.cert.issuer
  - Process is Modified?: %pe.is_modified

min-engine-version: 2.4.0
